# =============================================================================
# GitHub Actions CI Workflow for MLflow Project
# =============================================================================
#
# Level Support:
# - üîπ BASIC:    Steps 1-7 (checkout, setup python, install deps, run mlflow)
# - üîπ SKILLED:  Steps 1-7 + DagsHub tracking (artifacts uploaded to DagsHub)
# - üîπ ADVANCED: Steps 1-12 (+ Docker build & push to Docker Hub)
#
# Trigger: push to main/master, pull_request, or manual dispatch
# =============================================================================

name: MLflow CI Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch: # Manual trigger

env:
  PYTHON_VERSION: "3.12.7"
  MLFLOW_TRACKING_URI: "https://dagshub.com/riqalter/msml-mikailthoriq.mlflow"

jobs:
  train:
    name: Train ML Model
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: MLProject

    steps:
      # =========================================
      # üîπ BASIC - Step 1: Checkout repository
      # =========================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================================
      # üîπ BASIC - Step 2: Setup Python
      # =========================================
      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # =========================================
      # üîπ BASIC - Step 3: Install uv
      # =========================================
      - name: Install uv
        working-directory: .
        run: |
          pip install uv
          echo "uv installed successfully"

      # =========================================
      # üîπ BASIC - Step 4: Check environment
      # =========================================
      - name: Check environment
        run: |
          echo "=== Python Environment ==="
          python --version
          pip --version
          uv --version
          echo "=== Working Directory ==="
          pwd
          ls -la

      # =========================================
      # üîπ BASIC - Step 5: Install dependencies
      # =========================================
      - name: Install dependencies
        run: |
          uv pip install --system -r requirements.txt
          echo "=== Installed Packages ==="
          pip list

      # =========================================
      # üîπ SKILLED - Step 6: Set MLflow Tracking URI (DagsHub)
      # =========================================
      - name: Set MLflow Tracking URI
        run: |
          echo "MLFLOW_TRACKING_URI=${{ env.MLFLOW_TRACKING_URI }}" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_USERNAME=${{ secrets.MLFLOW_TRACKING_USERNAME }}" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_PASSWORD=${{ secrets.MLFLOW_TRACKING_PASSWORD }}" >> $GITHUB_ENV
          echo "MLflow tracking configured to DagsHub: ${{ env.MLFLOW_TRACKING_URI }}"

      # =========================================
      # üîπ BASIC - Step 7: Run MLflow Project
      # =========================================
      - name: Run MLflow Project
        id: mlflow_run
        run: |
          echo "=== Starting MLflow Training ==="
          mlflow run . --env-manager=local 2>&1 | tee mlflow_output.txt
          echo "=== Training Complete ==="
          echo "Artifacts uploaded to DagsHub: ${{ env.MLFLOW_TRACKING_URI }}"

          # Extract run ID from output
          RUN_ID=$(grep -oP "runs/\K[a-f0-9]+" mlflow_output.txt | head -1)
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Extracted Run ID: $RUN_ID"

      # =========================================
      # üîπ SKILLED - Step 8: Display DagsHub Links
      # =========================================
      - name: Display DagsHub Links
        run: |
          echo "=============================================="
          echo "üéâ Training Complete! View results on DagsHub:"
          echo "=============================================="
          echo "üìä Experiment: ${{ env.MLFLOW_TRACKING_URI }}/#/experiments/0"
          echo "üèÉ Run: ${{ env.MLFLOW_TRACKING_URI }}/#/experiments/0/runs/${{ steps.mlflow_run.outputs.run_id }}"
          echo "=============================================="
          echo "üìÅ Local artifacts saved to: artifacts/"
          ls -la artifacts/

      # =========================================
      # üîπ SKILLED - Step 9: Upload artifacts to GitHub
      # =========================================
      - name: Upload MLflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-artifacts
          path: MLProject/artifacts/
          retention-days: 30

      # =========================================
      # üîπ ADVANCED - Docker Steps (Uncomment when Docker Hub secrets are configured)
      # =========================================
      # To enable Docker build and push:
      # 1. Add DOCKERHUB_USERNAME and DOCKERHUB_TOKEN secrets in GitHub repo settings
      # 2. Uncomment the steps below

      # - name: Build Docker image
      #   run: |
      #     pip install mlflow[extras]
      #     MODEL_URI="runs:/${{ steps.mlflow_run.outputs.run_id }}/model"
      #     echo "Building Docker image from: $MODEL_URI"
      #     mlflow models build-docker --model-uri "$MODEL_URI" --name "titanic-classifier"
      #     docker images

      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}

      # - name: Tag and Push Docker image
      #   run: |
      #     docker tag titanic-classifier:latest ${{ secrets.DOCKERHUB_USERNAME }}/titanic-classifier:latest
      #     docker tag titanic-classifier:latest ${{ secrets.DOCKERHUB_USERNAME }}/titanic-classifier:${{ github.sha }}
      #     docker push ${{ secrets.DOCKERHUB_USERNAME }}/titanic-classifier:latest
      #     docker push ${{ secrets.DOCKERHUB_USERNAME }}/titanic-classifier:${{ github.sha }}
      #     echo "Docker images pushed successfully!"
